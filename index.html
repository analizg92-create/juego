<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sopa de letras: La c√©lula ‚Äî Turnos por Equipo</title>
    <style>
      :root {
        --ok: #22c55e;
        --bad: #ef4444;
        --main: #0b8043;
        --pill: #16a34a;
        --ink: #134e4a;
        --teamA: #3b82f6;
        --teamB: #f59e0b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, Segoe UI, Arial;
        margin: 0;
        background: linear-gradient(#d9fbe2, #f4fff6);
      }
      header {
        padding: 12px 16px;
        background: #e7ffe9;
        border-bottom: 2px solid #c6f6ce;
      }
      h1 {
        margin: 0;
        color: var(--main);
        font-size: clamp(18px, 3.4vw, 28px);
      }
      .wrap {
        max-width: 1140px;
        margin: auto;
        padding: 10px 16px;
      }
      .topbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .stats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .badge {
        background: #fff;
        border: 1px solid #d1fae5;
        border-radius: 10px;
        padding: 6px 10px;
        font-weight: 700;
        color: var(--ink);
      }
      .badge.turn {
        font-size: 18px;
        padding: 10px 16px;
        animation: pulse 2s ease-in-out infinite;
        font-weight: 900;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        50% {
          transform: scale(1.08);
          box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.4);
        }
      }
      .badge.teamA {
        background: #dbeafe;
        border-color: #93c5fd;
        color: #1e3a8a;
      }
      .badge.teamB {
        background: #fed7aa;
        border-color: #fdba74;
        color: #78350f;
      }
      .btn {
        cursor: pointer;
        border: 0;
        border-radius: 10px;
        padding: 8px 12px;
        background: var(--pill);
        color: #fff;
        font-weight: 700;
      }
      .btn.secondary {
        background: #0ea5e9;
      }
      .btn.warn {
        background: #f59e0b;
      }
      .btn.danger {
        background: #ef4444;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .game {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 18px;
        margin-top: 12px;
      }
      @media (max-width: 900px) {
        .game {
          grid-template-columns: 1fr;
        }
      }
      #grid {
        display: grid;
        grid-template-columns: repeat(13, 44px);
        justify-content: center;
        gap: 4px;
        padding: 10px;
        background: #f8fff9;
        border: 2px solid #d9fbe2;
        border-radius: 14px;
      }
      .cell {
        width: 44px;
        height: 44px;
        background: #fff;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        user-select: none;
        transition: transform 0.06s;
      }
      .cell:hover {
        transform: scale(1.05);
      }
      .picked {
        outline: 2px solid #60a5fa;
      }
      .good {
        background: #c8f7c5 !important;
        color: #064e3b !important;
        border-color: #86efac;
      }
      .badflash {
        animation: bad 0.35s;
      }
      @keyframes bad {
        0%,
        100% {
          background: #fff;
        }
        50% {
          background: #ffe4e6;
        }
      }
      .side {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .panel {
        background: #ffffff;
        border: 2px solid #dcfce7;
        border-radius: 14px;
        padding: 14px;
      }
      .title {
        margin: 0 0 8px;
        color: var(--main);
      }
      #words {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .word {
        background: #bbf7d0;
        color: #065f46;
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 800;
        cursor: pointer;
        border: 2px solid #86efac;
      }
      .word.active {
        background: #34d399;
        color: #052e25;
        border-color: #10b981;
      }
      .word.done {
        background: #a7f3d0;
        text-decoration: line-through;
        opacity: 0.7;
        cursor: default;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      input[type="text"],
      input[type="number"] {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        font-size: 14px;
      }
      .tiny {
        font-size: 12px;
        color: #334155;
      }
      footer {
        padding: 10px 16px 22px;
        text-align: center;
        color: #475569;
      }
      /* Modal de inicio */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
      }
      .modal {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
      }
      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .modal h2 {
        margin: 0 0 20px;
        color: var(--main);
        font-size: 28px;
        text-align: center;
      }
      .modal-content {
        margin-bottom: 20px;
      }
      .modal-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8fff9;
        border-radius: 12px;
        border: 2px solid #d9fbe2;
      }
      .modal-section h3 {
        margin: 0 0 10px;
        color: var(--ink);
        font-size: 16px;
      }
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .modal .btn {
        flex: 1;
        padding: 12px 20px;
        font-size: 16px;
      }
      .hidden {
        display: none;
      }
      /* Modal de resumen de turno */
      .summary-modal {
        text-align: center;
      }
      .summary-modal .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
      }
      .summary-modal .stat-box {
        padding: 15px;
        background: #f8fff9;
        border-radius: 12px;
        border: 2px solid #d9fbe2;
      }
      .summary-modal .stat-label {
        font-size: 14px;
        color: #64748b;
        margin-bottom: 5px;
      }
      .summary-modal .stat-value {
        font-size: 28px;
        font-weight: 900;
        color: var(--main);
      }
      #gameArea {
        filter: blur(3px);
        pointer-events: none;
        user-select: none;
      }
      #gameArea.active {
        filter: none;
        pointer-events: auto;
        user-select: auto;
        transition: filter 0.3s ease;
      }
      #turnIndicator {
        text-align: center;
        font-size: 24px;
        font-weight: 900;
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
      #turnIndicator.teamA {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 4px solid #3b82f6;
      }
      #turnIndicator.teamB {
        background: linear-gradient(135deg, #fed7aa, #fde68a);
        color: #92400e;
        border: 4px solid #f59e0b;
      }
      .score-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .team-score {
        padding: 16px;
        border-radius: 12px;
        text-align: center;
        font-weight: 700;
        transition: transform 0.2s;
      }
      .team-score:hover {
        transform: translateY(-2px);
      }
      .team-score.teamA {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border: 3px solid #3b82f6;
        color: #1e40af;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }
      .team-score.teamB {
        background: linear-gradient(135deg, #fed7aa, #fde68a);
        border: 3px solid #f59e0b;
        color: #92400e;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
      }
      .team-score.active {
        animation: scoreGlow 1.5s ease-in-out infinite;
      }
      @keyframes scoreGlow {
        0%, 100% { box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); }
        50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6); }
      }
    </style>
  </head>
  <body>
    <!-- Modal de inicio -->
    <div id="startModal" class="modal-overlay">
      <div class="modal">
        <h2>üî¨ Sopa de Letras: La C√©lula</h2>
        <div class="modal-content">
          <div class="modal-section">
            <h3>‚öôÔ∏è Configuraci√≥n del Juego</h3>
            <div class="row" style="margin-bottom: 10px;">
              <label style="flex: 1;">
                Equipo A: <input id="startNameA" type="text" value="Equipo A" style="width: 100%;">
              </label>
            </div>
            <div class="row" style="margin-bottom: 10px;">
              <label style="flex: 1;">
                Equipo B: <input id="startNameB" type="text" value="Equipo B" style="width: 100%;">
              </label>
            </div>
            <div class="row">
              <label style="flex: 1;">
                Minutos por turno:
                <input id="startMins" type="number" min="1" max="15" value="3" style="width: 100%;">
              </label>
            </div>
          </div>

          <div class="modal-section">
            <h3>üéÆ ¬øQui√©n empieza?</h3>
            <div class="modal-buttons">
              <button id="startWithA" class="btn" style="background: #3b82f6;">
                Equipo A
              </button>
              <button id="startWithB" class="btn" style="background: #f59e0b;">
                Equipo B
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de resumen de turno -->
    <div id="summaryModal" class="modal-overlay hidden">
      <div class="modal summary-modal">
        <h2 id="summaryTitle">üéâ Turno Finalizado</h2>
        <div class="modal-content">
          <div class="modal-section">
            <h3 id="summaryTeam">Equipo A</h3>
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-label">Palabras encontradas</div>
                <div class="stat-value" id="summaryWords">0/15</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Puntos obtenidos</div>
                <div class="stat-value" id="summaryPoints">0</div>
              </div>
            </div>
          </div>
          <p style="color: #64748b; margin: 15px 0;">¬°Ahora es el turno del otro equipo!</p>
        </div>
        <div class="modal-buttons">
          <button id="summaryOk" class="btn">
            Continuar ‚û°Ô∏è
          </button>
        </div>
      </div>
    </div>

    <div id="gameArea">
      <header>
        <div class="wrap topbar">
          <h1>üî¨ La c√©lula ‚Äî Sopa por Turnos</h1>
          <div class="stats">
            <div class="badge turn" id="currentTurn">üéØ Turno: Equipo A</div>
            <div class="badge">‚è± Tiempo: <span id="time">03:00</span></div>
            <div class="badge">
              üéØ Encontradas: <span id="hits">0</span>/<span id="total">0</span>
            </div>
          </div>
        </div>
      </header>

      <div class="wrap game">
      <!-- GRID -->
      <div>
        <div id="turnIndicator" class="teamA">
          üéÆ Turno de <span id="turnTeam">Equipo A</span>
        </div>
        <div id="grid" aria-label="Sopa de letras"></div>
        <div class="panel">
          <div class="row">
            <button id="addTime" class="btn secondary">+30s</button>
            <button id="mute" class="btn">üîä Sonido: ON</button>
            <button id="skipTurn" class="btn warn">‚è≠ Cambiar Turno</button>
            <button id="resetGame" class="btn danger">üîÑ Reiniciar Todo</button>
          </div>
          <p class="tiny">
            üí° <b>Tip:</b> Selecciona la <b>primera y √∫ltima letra</b> de la palabra en l√≠nea recta (horizontal, vertical o diagonal).
          </p>
        </div>
      </div>

      <!-- LATERAL -->
      <aside class="side">
        <div class="panel">
          <h3 class="title">‚öôÔ∏è Configuraci√≥n</h3>
          <div class="row">
            <label
              >Equipo A: <input id="nameA" type="text" value="Equipo A"
            /></label>
            <label
              >Equipo B: <input id="nameB" type="text" value="Equipo B"
            /></label>
          </div>
          <div class="row" style="margin-top: 6px">
            <label
              >Minutos por turno:
              <input id="minsInput" type="number" min="1" max="15" value="3"
            /></label>
            <button id="applyCfg" class="btn secondary">Aplicar</button>
          </div>
        </div>

        <div class="panel">
          <h3 class="title">üèÜ Puntuaci√≥n</h3>
          <div class="score-panel">
            <div class="team-score teamA" id="scoreCardA">
              <div id="nameADisplay" style="font-size: 16px; font-weight: 800;">Equipo A</div>
              <div style="font-size: 36px; margin-top: 8px; font-weight: 900;">
                <span id="scoreA">0</span>
              </div>
              <div style="font-size: 14px; opacity: 0.8;">puntos</div>
            </div>
            <div class="team-score teamB" id="scoreCardB">
              <div id="nameBDisplay" style="font-size: 16px; font-weight: 800;">Equipo B</div>
              <div style="font-size: 36px; margin-top: 8px; font-weight: 900;">
                <span id="scoreB">0</span>
              </div>
              <div style="font-size: 14px; opacity: 0.8;">puntos</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3 class="title">üëÄ Palabras a Buscar</h3>
          <div id="words"></div>
        </div>

        <div class="panel">
          <h3 class="title">‚Ñπ Definici√≥n</h3>
          <div id="info">Toca una palabra para ver su funci√≥n.</div>
        </div>

        <div class="panel">
          <h3 class="title">üìä Ranking de clases (hist√≥rico)</h3>
          <table id="leader">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Ganador</th>
                <th>Marcador</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="row">
            <button id="clearRank" class="btn danger">Borrar ranking</button>
          </div>
        </div>
      </aside>
    </div>

      <footer>
        ¬© Recurso educativo ‚Äî 6.¬∫ grado. Hecho para pizarras interactivas.
      </footer>
    </div>

    <script>
      /*************** Datos base del tablero ***************/
      const baseLetters = [
        "T G S D C E L U L A V M G X",
        "A O P A R E D C E L U L A R",
        "R I B O S O M A S O S R B K",
        "T M A C I T O P L A S M A I",
        "S E B E U C A R I O T A K L",
        "A N I M A L N U C L E L O X",
        "P B L I S O S O M A S G P L",
        "U P R O C A R I O T A W J P",
        "C L O R O P L A S T O S D O",
        "L C D V V A C U O L A S K P",
        "P D R F L I S O S O M A S U",
        "G V M I T O C O N D R I A S",
        "O W U C A P S U L A N A N G",
        "V E G E T A L F L A G E L O",
      ];

      const wordsDefinitions = {
        CELULA: "Unidad b√°sica de los seres vivos. Realiza funciones vitales.",
        "PARED CELULAR":
          "Capa r√≠gida que protege y da forma a c√©lulas vegetales.",
        RIBOSOMAS: "Fabrican prote√≠nas para la c√©lula.",
        CITOPLASMA: "Medio gelatinoso donde est√°n los org√°nulos.",
        EUCARIOTA: "C√©lula con n√∫cleo definido (animales y plantas).",
        PROCARIONTA: "C√©lula sin n√∫cleo (bacterias).",
        NUCLEO: "Dirige la c√©lula y guarda el ADN.",
        CLOROPLASTOS: "Hacen fotos√≠ntesis en plantas.",
        VACUOLAS: "Almacenan agua y nutrientes.",
        LISOSOMAS: "Reciclan desechos celulares.",
        MITOCONDRIAS: "Producen energ√≠a (ATP).",
        CAPSULA: "Capa protectora en algunas bacterias.",
        VEGETAL: "Tipo de c√©lula propia de plantas.",
        ANIMAL: "Tipo de c√©lula de los animales.",
        FLAGELO: '"Cola" que permite movimiento en algunas c√©lulas.',
      };

      /*************** Elementos ***************/
      const grid = document.getElementById("grid");
      const wordList = document.getElementById("words");
      const info = document.getElementById("info");
      const hitsEl = document.getElementById("hits");
      const totalEl = document.getElementById("total");
      const scoreAEl = document.getElementById("scoreA");
      const scoreBEl = document.getElementById("scoreB");
      const timeEl = document.getElementById("time");
      const currentTurnEl = document.getElementById("currentTurn");
      const turnIndicator = document.getElementById("turnIndicator");
      const turnTeam = document.getElementById("turnTeam");
      const nameAInput = document.getElementById("nameA");
      const nameBInput = document.getElementById("nameB");
      const nameADisplay = document.getElementById("nameADisplay");
      const nameBDisplay = document.getElementById("nameBDisplay");
      const scoreCardA = document.getElementById("scoreCardA");
      const scoreCardB = document.getElementById("scoreCardB");
      const minsInput = document.getElementById("minsInput");
      const applyCfgBtn = document.getElementById("applyCfg");
      const addTimeBtn = document.getElementById("addTime");
      const muteBtn = document.getElementById("mute");
      const skipTurnBtn = document.getElementById("skipTurn");
      const resetGameBtn = document.getElementById("resetGame");
      const leaderBody = document.querySelector("#leader tbody");
      const clearRankBtn = document.getElementById("clearRank");

      // Elementos del modal
      const startModal = document.getElementById("startModal");
      const startNameAInput = document.getElementById("startNameA");
      const startNameBInput = document.getElementById("startNameB");
      const startMinsInput = document.getElementById("startMins");
      const startWithABtn = document.getElementById("startWithA");
      const startWithBBtn = document.getElementById("startWithB");
      const summaryModal = document.getElementById("summaryModal");
      const summaryTitle = document.getElementById("summaryTitle");
      const summaryTeam = document.getElementById("summaryTeam");
      const summaryWords = document.getElementById("summaryWords");
      const summaryPoints = document.getElementById("summaryPoints");
      const summaryOkBtn = document.getElementById("summaryOk");
      const gameArea = document.getElementById("gameArea");

      /*************** Estado del juego ***************/
      let currentTeam = "A"; // "A" o "B"
      let scoreA = 0,
        scoreB = 0;
      let activeWord = null;
      let firstPick = null;
      let foundMap = new Map();
      let hits = 0;
      let totalSeconds = 180;
      let timerId = null;
      let muted = false;
      let gameStarted = false;

      // Estado del tablero actual
      let currentLetters = [];
      let currentWords = [];
      let cells = [];
      let rows = 0,
        cols = 0;

      /*************** Funciones de aleatorizaci√≥n ***************/
      function shuffleArray(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function rotateGrid(letters) {
        // 25% probabilidad de rotar 90¬∞, 25% de rotar 180¬∞, 25% de rotar 270¬∞, 25% sin rotar
        const rotationType = Math.floor(Math.random() * 4);

        if (rotationType === 0) return letters; // Sin rotar

        const grid = letters.map((row) => row.split(" "));
        let rotated = grid;

        for (let rotation = 0; rotation < rotationType; rotation++) {
          const newGrid = [];
          const numRows = rotated.length;
          const numCols = rotated[0].length;

          for (let j = numCols - 1; j >= 0; j--) {
            const newRow = [];
            for (let i = 0; i < numRows; i++) {
              newRow.push(rotated[i][j]);
            }
            newGrid.push(newRow);
          }
          rotated = newGrid;
        }

        return rotated.map((row) => row.join(" "));
      }

      function flipGrid(letters) {
        // 50% probabilidad de voltear horizontalmente
        if (Math.random() < 0.5) {
          return letters.map((row) => row.split(" ").reverse().join(" "));
        }
        return letters;
      }

      function randomizeBoard() {
        // Copiar y transformar el tablero
        let newLetters = [...baseLetters];
        newLetters = rotateGrid(newLetters);
        newLetters = flipGrid(newLetters);

        // Mezclar el orden de las palabras
        const wordKeys = Object.keys(wordsDefinitions);
        const shuffledKeys = shuffleArray(wordKeys);

        return { letters: newLetters, wordOrder: shuffledKeys };
      }

      /*************** Sonidos ***************/
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      function beep(freq = 880, len = 0.12, type = "sine", vol = 0.15) {
        if (muted) return;
        const o = ctx.createOscillator(),
          g = ctx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + len);
        o.stop(ctx.currentTime + len);
      }
      function success() {
        beep(880, 0.09, "triangle");
        setTimeout(() => beep(1175, 0.09, "triangle"), 90);
      }
      function error() {
        beep(180, 0.18, "square", 0.2);
      }
      function tada() {
        beep(740, 0.12, "sine");
        setTimeout(() => beep(988, 0.18, "sine"), 120);
        setTimeout(() => beep(1319, 0.22, "sine"), 320);
      }

      /*************** Temporizador ***************/
      function fmt(s) {
        const m = String(Math.floor(s / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return m + ":" + ss;
      }

      function startTimer() {
        if (timerId) clearInterval(timerId);
        if (!gameStarted) return; // No iniciar el timer si el juego no ha comenzado

        timerId = setInterval(() => {
          if (totalSeconds > 0) {
            totalSeconds--;
            timeEl.textContent = fmt(totalSeconds);
          } else {
            clearInterval(timerId);
            endTurn("‚è± ¬°Tiempo finalizado!");
          }
        }, 1000);
      }

      /*************** Construir grilla ***************/
      function buildGrid(letters) {
        grid.innerHTML = "";
        cells = [];
        rows = letters.length;
        cols = letters[0].split(" ").length;

        letters.forEach((row, i) => {
          row.split(" ").forEach((ch, j) => {
            const id = i * cols + j;
            const div = document.createElement("div");
            div.className = "cell";
            div.textContent = ch;
            div.dataset.id = id;
            div.dataset.i = i;
            div.dataset.j = j;
            div.addEventListener("click", () => onCellClick(div));
            grid.appendChild(div);
            cells[id] = div;
          });
        });
      }

      function getChar(i, j) {
        if (i < 0 || j < 0 || i >= rows || j >= cols) return null;
        return currentLetters[i].split(" ")[j];
      }

      function lineIndices(i1, j1, i2, j2) {
        const di = Math.sign(i2 - i1),
          dj = Math.sign(j2 - j1);
        const len = Math.max(Math.abs(i2 - i1), Math.abs(j2 - j1)) + 1;
        if (
          (di === 0 && dj === 0) ||
          (di !== 0 && dj !== 0 && Math.abs(i2 - i1) !== Math.abs(j2 - j1))
        )
          return [];
        const out = [];
        for (let k = 0; k < len; k++)
          out.push((i1 + di * k) * cols + (j1 + dj * k));
        return out;
      }

      /*************** Palabras ***************/
      function buildWordList(wordOrder) {
        wordList.innerHTML = "";
        totalEl.textContent = wordOrder.length;

        wordOrder.forEach((w) => {
          const tag = document.createElement("button");
          tag.className = "word";
          tag.textContent = w;
          tag.addEventListener("click", () => {
            document
              .querySelectorAll(".word")
              .forEach((b) => b.classList.remove("active"));
            tag.classList.add("active");
            activeWord = w;
            info.innerHTML = `<b>${w}:</b> ${wordsDefinitions[w]}`;
            firstPick = null;
          });
          wordList.appendChild(tag);
        });
      }

      /*************** Interacci√≥n ***************/
      function onCellClick(div) {
        if (!activeWord) {
          info.textContent = "Selecciona una palabra primero üëÜ";
          error();
          return;
        }
        if (foundMap.has(activeWord)) return;

        div.classList.add("picked");
        if (!firstPick) {
          firstPick = div;
          beep(520, 0.06, "sine");
          return;
        }

        const i1 = +firstPick.dataset.i,
          j1 = +firstPick.dataset.j,
          i2 = +div.dataset.i,
          j2 = +div.dataset.j;
        const idxs = lineIndices(i1, j1, i2, j2),
          picked = idxs.map((id) => cells[id].textContent).join("");
        const clean = activeWord.replace(/\s+/g, "");
        const ok =
          picked === clean || picked.split("").reverse().join("") === clean;

        if (ok) {
          idxs.forEach((id) => cells[id].classList.add("good"));
          document.querySelectorAll(".word").forEach((b) => {
            if (b.textContent === activeWord) {
              b.classList.remove("active");
              b.classList.add("done");
            }
          });
          foundMap.set(activeWord, idxs);
          hits++;
          hitsEl.textContent = hits;

          // Sumar puntos al equipo actual
          const points = 10;
          if (currentTeam === "A") {
            scoreA += points;
            scoreAEl.textContent = scoreA;
          } else {
            scoreB += points;
            scoreBEl.textContent = scoreB;
          }

          success();

          if (hits === currentWords.length) {
            endTurn("üéâ ¬°Todas las palabras encontradas!");
          }
        } else {
          firstPick.classList.remove("picked");
          div.classList.remove("picked");
          firstPick.classList.add("badflash");
          div.classList.add("badflash");
          setTimeout(() => {
            firstPick.classList.remove("badflash");
            div.classList.remove("badflash");
          }, 320);
          error();

          // Restar puntos al equipo actual
          if (currentTeam === "A") {
            scoreA = Math.max(0, scoreA - 2);
            scoreAEl.textContent = scoreA;
          } else {
            scoreB = Math.max(0, scoreB - 2);
            scoreBEl.textContent = scoreB;
          }
        }
        firstPick = null;
      }

      /*************** Control de turnos ***************/
      function updateTurnUI() {
        const teamName =
          currentTeam === "A"
            ? nameAInput.value.trim() || "Equipo A"
            : nameBInput.value.trim() || "Equipo B";

        currentTurnEl.textContent = `üéØ Turno: ${teamName}`;
        turnTeam.textContent = teamName;

        turnIndicator.className = `team${currentTeam}`;
        currentTurnEl.className = `badge turn team${currentTeam}`;

        // Resaltar el marcador del equipo actual
        if (currentTeam === "A") {
          scoreCardA.classList.add("active");
          scoreCardB.classList.remove("active");
        } else {
          scoreCardB.classList.add("active");
          scoreCardA.classList.remove("active");
        }
      }

      function switchTeam() {
        currentTeam = currentTeam === "A" ? "B" : "A";
        updateTurnUI();

        // Peque√±o delay para que el usuario vea el cambio de turno
        setTimeout(() => {
          resetTurn();
        }, 500);
      }

      function endTurn(message) {
        clearInterval(timerId);
        tada();

        const teamName =
          currentTeam === "A"
            ? nameAInput.value.trim() || "Equipo A"
            : nameBInput.value.trim() || "Equipo B";

        const currentScore = currentTeam === "A" ? scoreA : scoreB;

        // Mostrar modal de resumen
        summaryTitle.textContent = message;
        summaryTeam.textContent = teamName;
        summaryWords.textContent = `${hits}/${currentWords.length}`;
        summaryPoints.textContent = currentScore;
        summaryModal.classList.remove("hidden");
      }

      function resetTurn() {
        // Generar nuevo tablero aleatorio
        const randomBoard = randomizeBoard();
        currentLetters = randomBoard.letters;
        currentWords = randomBoard.wordOrder;

        // Reconstruir tablero y palabras
        buildGrid(currentLetters);
        buildWordList(currentWords);

        // Resetear estado del turno
        foundMap.clear();
        hits = 0;
        hitsEl.textContent = 0;
        activeWord = null;
        firstPick = null;
        info.textContent = "Toca una palabra para ver su funci√≥n.";

        // Reiniciar temporizador
        totalSeconds = parseInt(minsInput.value || 3, 10) * 60;
        timeEl.textContent = fmt(totalSeconds);
        startTimer();
        beep();
      }

      function resetGame() {
        const shouldSaveScore = scoreA > 0 || scoreB > 0;

        if (shouldSaveScore) {
          // Mostrar modal de confirmaci√≥n personalizado
          showConfirmModal(
            "¬øReiniciar el juego?",
            "Se perder√°n los puntos actuales. ¬øDeseas continuar?",
            () => {
              // Si confirma, preguntar si quiere guardar
              showConfirmModal(
                "Guardar resultado",
                "¬øDeseas guardar el resultado actual en el ranking?",
                () => {
                  const teamAName = nameAInput.value.trim() || "Equipo A";
                  const teamBName = nameBInput.value.trim() || "Equipo B";

                  let winner = "Empate";
                  if (scoreA > scoreB) winner = teamAName;
                  else if (scoreB > scoreA) winner = teamBName;

                  const scoreStr = `${teamAName} ${scoreA} - ${scoreB} ${teamBName}`;
                  saveRank(winner, scoreStr);
                  performReset();
                },
                () => {
                  performReset();
                }
              );
            }
          );
        } else {
          performReset();
        }
      }

      function performReset() {
        gameStarted = false;
        clearInterval(timerId);
        scoreA = 0;
        scoreB = 0;
        scoreAEl.textContent = 0;
        scoreBEl.textContent = 0;
        gameArea.classList.remove("active");
        startModal.classList.remove("hidden");
      }

      function endGame() {
        clearInterval(timerId);

        const teamAName = nameAInput.value.trim() || "Equipo A";
        const teamBName = nameBInput.value.trim() || "Equipo B";

        let winner = "Empate";
        if (scoreA > scoreB) winner = teamAName;
        else if (scoreB > scoreA) winner = teamBName;

        const scoreStr = `${teamAName} ${scoreA} - ${scoreB} ${teamBName}`;
        saveRank(winner, scoreStr);

        alert(
          `üèÜ Juego finalizado\n\nGanador: ${winner}\nMarcador: ${scoreStr}`
        );

        resetGame();
      }

      /*************** Ranking (hist√≥rico en localStorage) ***************/
      const KEY = "celulaLeaderboard";
      function loadRank() {
        const arr = JSON.parse(localStorage.getItem(KEY) || "[]");
        leaderBody.innerHTML = "";
        arr.slice(0, 20).forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.date}</td><td>${r.winner}</td><td>${r.score}</td>`;
          leaderBody.appendChild(tr);
        });
      }

      function saveRank(winner, scoreStr) {
        const arr = JSON.parse(localStorage.getItem(KEY) || "[]");
        arr.unshift({
          date: new Date().toLocaleString(),
          winner,
          score: scoreStr,
        });
        localStorage.setItem(KEY, JSON.stringify(arr));
        loadRank();
      }

      /*************** Botones ***************/
      applyCfgBtn.onclick = () => {
        nameADisplay.textContent = nameAInput.value.trim() || "Equipo A";
        nameBDisplay.textContent = nameBInput.value.trim() || "Equipo B";
        updateTurnUI();
        totalSeconds = parseInt(minsInput.value || 3, 10) * 60;
        timeEl.textContent = fmt(totalSeconds);
        beep();
      };

      addTimeBtn.onclick = () => {
        totalSeconds += 30;
        timeEl.textContent = fmt(totalSeconds);
        beep(660, 0.1, "triangle");
      };

      muteBtn.onclick = (e) => {
        muted = !muted;
        e.target.textContent = muted ? "üîà Sonido: OFF" : "üîä Sonido: ON";
        if (!muted) beep();
      };

      skipTurnBtn.onclick = () => {
        const teamName = currentTeam === "A"
          ? (nameAInput.value.trim() || "Equipo A")
          : (nameBInput.value.trim() || "Equipo B");

        showConfirmModal(
          "¬øCambiar de turno?",
          `Se terminar√° el turno de ${teamName}.`,
          () => {
            endTurn("‚è≠ Turno cambiado manualmente");
          }
        );
      };

      resetGameBtn.onclick = resetGame;

      clearRankBtn.onclick = () => {
        showConfirmModal(
          "¬øBorrar ranking?",
          "Se eliminar√° todo el historial de partidas.",
          () => {
            localStorage.removeItem(KEY);
            loadRank();
          }
        );
      };

      /*************** Modal de confirmaci√≥n personalizado ***************/
      function showConfirmModal(title, message, onConfirm, onCancel) {
        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";
        overlay.innerHTML = `
          <div class="modal">
            <h2>${title}</h2>
            <div class="modal-content">
              <div class="modal-section">
                <p style="margin: 0; color: #64748b; font-size: 16px; text-align: center;">
                  ${message}
                </p>
              </div>
            </div>
            <div class="modal-buttons">
              <button class="btn danger" id="confirmNo">Cancelar</button>
              <button class="btn" id="confirmYes">Aceptar</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);

        document.getElementById("confirmYes").onclick = () => {
          document.body.removeChild(overlay);
          if (onConfirm) onConfirm();
        };

        document.getElementById("confirmNo").onclick = () => {
          document.body.removeChild(overlay);
          if (onCancel) onCancel();
        };
      }

      /*************** Inicio del juego ***************/
      startWithABtn.onclick = () => startGame("A");
      startWithBBtn.onclick = () => startGame("B");

      function startGame(team) {
        // Aplicar configuraci√≥n
        const teamAName = startNameAInput.value.trim() || "Equipo A";
        const teamBName = startNameBInput.value.trim() || "Equipo B";
        const minutes = parseInt(startMinsInput.value || 3, 10);

        nameAInput.value = teamAName;
        nameBInput.value = teamBName;
        nameADisplay.textContent = teamAName;
        nameBDisplay.textContent = teamBName;
        minsInput.value = minutes;

        currentTeam = team;
        gameStarted = true;

        // Ocultar modal y mostrar juego
        startModal.classList.add("hidden");
        gameArea.classList.add("active");

        updateTurnUI();
        resetTurn();
      }

      summaryOkBtn.onclick = () => {
        summaryModal.classList.add("hidden");
        switchTeam();
      };

      /*************** Inicio ***************/
      loadRank();

      // No iniciar el juego autom√°ticamente
      // El juego se iniciar√° cuando el usuario presione un bot√≥n en el modal

      // Mostrar definici√≥n al pasar el mouse
      wordList.addEventListener("mouseover", (e) => {
        if (e.target.classList.contains("word"))
          info.innerHTML = `<b>${e.target.textContent}:</b> ${
            wordsDefinitions[e.target.textContent]
          }`;
      });
    </script>
  </body>
</html>
